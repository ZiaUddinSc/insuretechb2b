{% extends 'base.html' %} 
{% load static %} 

{% block title %}User List{% endblock title%}

{% block extra_head %}

  <link href="{% static "/fonts/bootstrap-icons.css" %}" rel="stylesheet" type="text/css">

 
{% endblock extra_head %}

<!-- Layout wrapper -->
{% block content %} 

    {% include 'navbar.html' %}

    <div class="container-fluid page-body-wrapper">
    {% include 'layout.html' %}

    <div class="main-panel">
      <div class="content-wrapper">
      
        <div class="card mt">
          <div class="card-body">
            <div class="page-header">
              <h3 class="page-title">
                User List
              </h3>
              <nav aria-label="breadcrumb">
                <button type="button" class="btn btn-info" data-toggle="modal" data-target="#addUserModal" data-whatever="@mdo">Add User</button>
              </nav>
            </div>
            <div class="row">
              <div class="col-12">
                <div class="table-responsive">
                  <table id="user-list" class="table" >
                    <thead class="">
                      <tr>
                          <th>Email</th>
                          <th>User Name</th>
                          <th>Phone Number</th>
                          <th>Groups</th>
                          <th>Status</th>
                          <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          <div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="ModalLabel">Add User</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <ul class="errors">
                    {% comment %} <li style="color:red">Coffee</li> {% endcomment %}
                  </ul>
                  
                  <form id="form-user-add-information" method="POST" action="{% url "user-create" %}">
                    <div class="form-group">
                      <label for="email" class="col-form-label">Email</label>
                      <input type="text" class="form-control" id="email" name="email">
                    </div>
                    <div class="form-group">
                      <label for="username" class="col-form-label">User Name</label>
                      <input type="text" class="form-control" id="username" name="username">
                    </div>
                    <div class="form-group">
                      <label for="phone_number" class="col-form-label">Phone Number</label>
                      <input type="text" class="form-control" id="phone_number" name="phone_number">
                    </div>
                    <div class="form-group">
                      <label for="password" class="col-form-label">Password</label>
                      <input type="password" class="form-control" id="password" name="password">
                    </div>
                    <div class="form-group">
                      <label for="confirm-password" class="col-form-label">Confirm Password</label>
                      <input type="password" class="form-control" id="confirm-password" name="confirm_password">
                    </div>
                    <div class="form-group">
                      <label for="port" class="col-form-label">Group</label>
                      <select class="form-control" name="groups" multiple>
                        <option value="">-- Select Group --</option>
                        {% for group in groups %}
                          <option value="{{group.id}}">{{group.name}}</option>
                        {% endfor %}
                      
                      </select>                    
                    </div>
                      <div class="form-group d-flex align-items-center">
                        <span>Active Status</span>

                        <label class="switch mb-0 me-10">
                          <input type="checkbox" class="switch-input" name="is_active" id="is_active">
                          <span class="slider"></span>
                        </label>
                      </div> 
                    </div>
                <div class="modal-footer">
                  <button type="submit" id="save_user" class="btn btn-success">Save</button>
                  <button type="button" class="btn btn-light" data-dismiss="modal">Close</button>
                </div>
              </form>
              </div>
            </div>
          </div>
          <div class="modal fade" id="userInfoModal" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="ModalLabel">Update User Information</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <ul class="errors">
                    {% comment %} <li style="color:red">Coffee</li> {% endcomment %}
                  </ul>
                  
              <form id="form-update-user-information" data-id=""  method="PUT">
                <div class="form-group">
                  <label for="email" class="col-form-label">Email</label>
                  <input type="text" class="form-control" id="email" name="email">
                </div>
                <div class="form-group">
                  <label for="username" class="col-form-label">User Name</label>
                  <input type="text" class="form-control" id="username" name="username">
                </div>
                <div class="form-group">
                  <label for="phone_number" class="col-form-label">Phone Number</label>
                  <input type="text" class="form-control" id="phone_number" name="phone_number">
                </div>
                <div class="form-group">
                  <label for="password" class="col-form-label">Password</label>
                  <input type="password" class="form-control" id="update_password" name="update_password">
                </div>
                <div class="form-group">
                  <label for="confirm-password" class="col-form-label">Confirm Password</label>
                  <input type="password" class="form-control" id="update_confirm_password" name="update_confirm_password">
                </div>
                    <div class="form-group">
                      <label for="group" class="col-form-label">Group</label>
                      <select class="form-control" name="groups" multiple>
                        <option value="">-- Select Group --</option>
                        {% for group in groups %}
                          <option value="{{group.id}}">{{group.name}}</option>
                        {% endfor %}
                      
                      </select>                    
                    </div>
                    
                      <div class="form-group d-flex align-items-center">
                        <span>Active Status</span>

                        <label class="switch mb-0 me-10">
                          <input type="checkbox" class="switch-input" name="is_active" id="is_active">
                          <span class="slider"></span>
                        </label>
                      </div>
                     
                    
                 
                    </div>
                <div class="modal-footer">
                  <button type="button" id="update_user_info" class="btn btn-success">Update</button>
                  <button type="button" class="btn btn-light" data-dismiss="modal">Close</button>
                </div>
              </form>
              </div>
            </div>
          </div>

          </div>
       
      <!-- content-wrapper ends -->
      <!-- partial:../../partials/_footer.html -->
     
      <!-- partial -->
    </div> 
  
  {% include 'footer.html' %}
</div>
</div>
<!-- container-scroller -->



{% endblock content %}
<!-- / Layout wrapper -->

{% block extra_script %}


    <script>
      var userTable
      $(document).ready(function() {
        //Displaying Data by API
        userTable=$('#user-list').DataTable({
          "pageLength" : 10,
          "processing": true,
          "serverSide": true,
          "filter": true,
          "responsive": true,
          "order": [0, 'desc'],
          ajax: {
            "processing":false,
            "url": "{% url 'user-list' %}",
            "dataSrc": function (response) {
              return response.data;
           }
          },      
          columns: [
              {"mData":"email"},
              {"mData":"username",defaultContent:"N/A"},
              {"mData":"phone_number"},
              {"mData":"group_names"},
              {"mData": function (source) {
                return source.is_active == 1 ? "Active" : "Inactive";
                }
              },
              {"mData": function (source) {

                return  `<div class="action-buttons">
                  <a data-id="${source.id}" class="btn btn-outline-primary " id="useTemplateModal">Edit</a>
                  <a data-id="${source.id}" class="btn btn-outline-danger bank-delete">Delete</a>
                </div>`
                }
              },
          ],
          buttons: [
          'pdf',
          'excel',
          'print',
          'csv'
          ]
        });
        //Validation and Submit data

        (function($) {
          'use strict';
        var  validator = $.validator.setDefaults({
            submitHandler: function() {
              var form = $('#form-user-add-information')
              $.ajax({
                type: "POST",
                headers: {//<==
                  "X-CSRFTOKEN": "{{ csrf_token }}"//<==
                },
                url: form.attr("action"), 
                data: form.serialize(), // serializes the form's elements.
                success: function(response) {
                  console.log(response)
                  if(response.success){
                    $.toast({
                      heading: 'Success',
                      text: response.message,
                      showHideTransition: 'slide',
                      icon: 'success',
                      loaderBg: '#f96868',
                      position: 'top-right'
                    })
                    // Closing Model After submission 
                    $("#addUserModal .close").click()
                    $().removeClass("errors");
                    // Restting form After submission 
                    $("#form-user-add-information")[0].reset();
                    //Resetting Error message
                    $('.errors li').remove();
                     userTable.ajax.reload();
                  }else{
                    if(response.data){
                      if (response.data.hasOwnProperty("email")) {
                        $('.errors').append('<li class="li-style" style="color:red;text-transform:capitalize">Email Already Exists</li>')
                      }
                      if (response.data.hasOwnProperty("username")){
                        $('.errors').append('<li class="li-style" style="color:red;text-transform:capitalize">User Name already Exists</li>')
                      }
                      if (response.data.hasOwnProperty("phone_number")){
                        $('.errors').append('<li class="li-style" style="color:red;text-transform:capitalize">Phone Number already Exists</li>')
                      }
                    }
                    $.toast({
                      heading: 'Danger',
                      text: "User creation failed",
                      showHideTransition: 'slide',
                      icon: 'error',
                      loaderBg: '#f2a654',
                      position: 'top-right'
                    })
                  }
                }
             });
            }
          });
          $(function() {
      
            // validate organization form  on keyup and submit
            $("#form-user-add-information").validate({
              rules: {
                email: "required",
                username : "required",
                password : "required",
                confirm_password: {
                  required: true,
                  equalTo: "#password" // Must match password field ID
                }
              },
              messages: {
                email: "Please enter name",
                username: "Please enter user name",
                password: {
                  required: "Please enter your password",
                  minlength: "Password must be at least 6 characters long"
                },
                confirm_password: {
                  required: "Please confirm your password",
                  equalTo: "Passwords do not match"
                }
              },
              errorPlacement: function(label, element) {
                label.addClass('mt-2 text-danger');
                label.insertAfter(element);
              },
              highlight: function(element, errorClass) {
                $(element).parent().addClass('has-danger')
                $(element).addClass('form-control-danger')
              }
            });
         
          });
        })(jQuery);

 
        
        
        //Viewing data after clicking edit button in table

        $(document).on('click','#useTemplateModal',function(e){
          e.preventDefault()
          var id = $(this).attr('data-id')
          var form= $('#form-update-user-information')
          form.attr('data-id',id)
          $('#userInfoModal').modal('toggle')
          $.ajax({
            type: "GET",
            headers: {//<==
              "X-CSRFTOKEN": "{{ csrf_token }}"//<==
            },
            url: '/user/'+id+'/', 
            success: function(response) {
               if(response?.success){
                form.find('#username').val(response.data.username)
                form.find('#email').val(response.data.email)
                form.find('#phone_number').val(response.data.phone_number)
                form.find('select[name="groups"]').val(response.data.groups).trigger('change');
                form.find('#is_active').prop('checked', response.data.is_active);
               }else{
                alert("Something error")
               }
            }
            });
        })

        const validator = $("#form-update-user-information").validate({
          rules: {
            email: { required: true, email: true },
            username: { required: true },
            phone_number: { required: true },
            update_password: {
              required: function () {
                return $("#update_confirm_password").val().length > 0;
              },
              minlength: 6
            },
            update_confirm_password: {
              required: function () {
                return $("#update_password").val().length > 0;
              },
              equalTo: "#update_password"
            }
          },
          messages: {
            email: "Please enter a valid email address",
            username: "Please enter a username",
            phone_number: "Please enter a phone number",
            update_password: {
              required: "Please enter a password",
              minlength: "Password must be at least 6 characters"
            },
            update_confirm_password: {
              required: "Please confirm your password",
              equalTo: "Passwords do not match"
            }
          },
          errorClass: "text-danger"
        });
        $(document).on("click","#update_user_info", function (e) {
          e.preventDefault(); // Prevent actual submit
          if ($("#form-update-user-information").valid()) {
            var form =$("#form-update-user-information")
            const id =form.attr('data-id')
            $.ajax({
              type: "PUT",
              headers: {//<==
                "X-CSRFTOKEN": "{{ csrf_token }}"//<==
              },
              url: '/user/'+id+'/', 
              data: form.serialize()+'&id='+id,// serializes the form's elements.
              success: function(response) {
                if(response.success){
                  $.toast({
                    heading: 'Success',
                    text: response.message,
                    showHideTransition: 'slide',
                    icon: 'success',
                    loaderBg: '#f96868',
                    position: 'top-right'
                  })
                  // Closing Model After submission 
                  $("#userInfoModal .close").click()
                  $().removeClass("errors");
                  // Restting form After submission 
                  $("#form-update-user-information")[0].reset();
                  //Resetting Error message
                  $('.errors li').remove();
                   userTable.ajax.reload();
                }else{
                  if(response.data){
                    if (response.data.hasOwnProperty("email")) {
                      $('.errors').append('<li class="li-style" style="color:red;text-transform:capitalize">Email Already Exists</li>')
                    }
                    if (response.data.hasOwnProperty("username")){
                      $('.errors').append('<li class="li-style" style="color:red;text-transform:capitalize">User Name already Exists</li>')
                    }
                    if (response.data.hasOwnProperty("phone_numbner")){
                      $('.errors').append('<li class="li-style" style="color:red;text-transform:capitalize">Phone Number already Exists</li>')
                    }
                  }
                  $.toast({
                    heading: 'Danger',
                    text: "User creation failed",
                    showHideTransition: 'slide',
                    icon: 'error',
                    loaderBg: '#f2a654',
                    position: 'top-right'
                  })
                }
              }
           });
          } else {
            // ‚ùå Form invalid - errors will show automatically
            console.log("Validation failed");
          }
        });
  
        //Delete Module
        $('#user-list').on('click', '.bank-delete', function (event) {      
          var row = userTable.row($(this).parents('tr'));
          var id = ($(this).attr('data-id'))
          swal({
            title: "Are you sure?",
            text: "You will not be able to recover this data!",
            icon: "warning",
            buttons: [
              'Cancel',
              'Confirm'
            ],
            dangerMode: true,
          }).then(function(isConfirm) {
            if (isConfirm) {
                $.ajax({
                  type:'DELETE',
                  headers: {//<==
                    "X-CSRFTOKEN": "{{ csrf_token }}"//<==
                  },
                  url:'/b2bmanagement/bank-save/'+id+'/',
                  success: function(data){
                    if(data.error){  //You are checking for true/false not yes or no.
                      $.toast({
                        heading: 'Danger',
                        text: "Something wrong.data didn't delete",
                        showHideTransition: 'slide',
                        icon: 'error',
                        loaderBg: '#f2a654',
                        position: 'top-right'
                      })
                    }else{
                      userTable.ajax.reload();
                    }
                  }
                });
            } else {
              swal("Cancelled", "Your data is safe :)", "error");
            }
          })
         
        });

      });
     
  </script>
  {% endblock extra_script %}